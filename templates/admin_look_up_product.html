<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{page_title}}</title>
    <link rel="stylesheet" href="/css/admin-main.css">
    <link rel="stylesheet" href="/css/admin-login.css">
    <link rel="stylesheet" href="/css/admin-products.css">
</head>

<body>
    <header class="admin-section admin-header">
        <div class="admin-header-home-button">
            <a href="/core/ops/admin/dashboard" class="quicksand-text white-text text">Home</a>
        </div>
        <div class="admin-header-home-button">
            <a target="_blank" href="/" class="quicksand-text white-text text">Go to Store</a>
        </div>
        <div class="admin-header-logout-button">
            <a href="/core/ops/admin/logout" class="quicksand-text white-text text">Signout</a>
        </div>
    </header>
    <section class="admin-section admin-page-title">
        <h1 class="rhino-text quicksand-text title">Admin Panel</h1>
    </section>
    <script>
        (async function adminGuard() {
            try {
                // Call auth check endpoint (cookie is sent automatically by browser)
                const res = await fetch("/core/ops/admin/api/auth/check", {
                    method: "GET",
                    credentials: "same-origin",
                    cache: "no-store",
                });

                if (!res.ok) {
                    // Not logged in → send to admin login
                    window.location.replace("/core/ops/admin/login");
                    return;
                }
            } catch (err) {
                // If server unreachable or anything weird → safer to go login
                window.location.replace("/core/ops/admin/login");
            }
        })();
    </script>
    <section class="admin-section">
        <div class="prod-lookup-wrap">

            <div class="prod-page-top">
                <div>
                    <h2 class="rhino-text quicksand-text sub-title">{{ heading }}</h2>
                    <p class="lato-text text gray-text">
                        Search products using any combination of fields. At least one field is required.
                    </p>
                </div>

                <div class="prod-actions">
                    <a href="/core/ops/admin/dashboard/add-product"
                        class="prod-action-btn prod-primary quicksand-text text">
                        + Add Product
                    </a>

                    <a href="/core/ops/admin/dashboard" class="prod-action-btn quicksand-text text">
                        ← Back
                    </a>
                </div>
            </div>

            {% if error %}
            <div class="prod-error lato-text text">{{ error }}</div>
            {% endif %}

            <form id="productLookupForm" method="get" action="/core/ops/admin/dashboard/search-results-product"
                class="prod-form">

                <div class="prod-grid-2">
                    <div>
                        <label class="lato-text text gray-text">Product ID</label>
                        <input class="prod-input" type="text" name="product_id" placeholder="e.g. 12"
                            value="{{ filters.product_id }}">
                    </div>

                    <div>
                        <label class="lato-text text gray-text">Name</label>
                        <input class="prod-input" type="text" name="name" placeholder="e.g. Product 1"
                            value="{{ filters.name }}">
                    </div>
                </div>

                <div class="prod-grid-2">
                    <div>
                        <label class="lato-text text gray-text">Category</label>
                        <select id="categorySelect" name="category_id" class="prod-select">
                            <option value="all" {% if filters.category_id=="all" %}selected{% endif %}>
                                All Categories
                            </option>
                            {% for c in categories_with_subcategories %}
                            <option value="{{ c.slug }}" {% if filters.category_id==c.slug %}selected{% endif %}>
                                {{ c.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="lato-text text gray-text">Subcategory</label>
                        <select id="subcategorySelect" name="sub_category_id" class="prod-select">
                            <option value="all" {% if filters.sub_category_id=="all" %}selected{% endif %}>
                                All Subcategories
                            </option>
                            <!-- JS will populate based on selected category -->
                        </select>

                        <p class="prod-hint lato-text text gray-text">
                            If Category is All, subcategory is locked to All.
                        </p>
                    </div>
                </div>

                <!-- ✅ NEW FILTERS -->
                <div class="prod-checks">
                    <label class="prod-checkbox lato-text text gray-text">
                        <input type="checkbox" name="is_featured" value="true" {% if filters.is_featured %}checked{%
                            endif %}>
                        Featured only
                    </label>

                    <label class="prod-checkbox lato-text text gray-text">
                        <input type="checkbox" name="is_hot_deal" value="true" {% if filters.is_hot_deal %}checked{%
                            endif %}>
                        Hot deal only
                    </label>
                </div>

                <button type="submit" class="prod-primary-btn quicksand-text text">
                    Search
                </button>

            </form>

            <!-- inline JS will handle dependent dropdown + validation -->
        </div>
    </section>
    <script>
        (function () {
            const CATS = {{ categories_with_subcategories | tojson
        }};
        const categorySelect = document.getElementById("categorySelect");
        const subcategorySelect = document.getElementById("subcategorySelect");
        const form = document.getElementById("productLookupForm");

        const defaultCategory = "{{ filters.category_id }}";
        const defaultSub = "{{ filters.sub_category_id }}";

        function getSubcategoriesFor(catSlug) {
            const cat = (CATS || []).find(c => c.slug === catSlug);
            return cat ? (cat.subcategories || []) : [];
        }

        function clearOptions(selectEl) {
            while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
        }

        function addOption(selectEl, value, text, selected) {
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = text;
            if (selected) opt.selected = true;
            selectEl.appendChild(opt);
        }

        function renderSubcategories(catSlug, selectedSub) {
            clearOptions(subcategorySelect);

            // Always include All option
            addOption(subcategorySelect, "all", "All Subcategories", selectedSub === "all");

            if (catSlug === "all") {
                subcategorySelect.value = "all";
                subcategorySelect.disabled = true;
                return;
            }

            subcategorySelect.disabled = false;

            const subs = getSubcategoriesFor(catSlug);
            subs.forEach(s => {
                addOption(subcategorySelect, s.slug, s.name, s.slug === selectedSub);
            });

            // If selectedSub not found, fallback to all
            const exists = Array.from(subcategorySelect.options).some(o => o.value === selectedSub);
            subcategorySelect.value = exists ? selectedSub : "all";
        }

        // init dropdowns
        if (categorySelect && subcategorySelect) {
            if (defaultCategory) categorySelect.value = defaultCategory;

            renderSubcategories(categorySelect.value || "all", defaultSub || "all");

            categorySelect.addEventListener("change", () => {
                const cat = categorySelect.value || "all";
                renderSubcategories(cat, "all");
            });
        }

        // client-side validation
        if (form) {
            form.addEventListener("submit", (e) => {
                const pid = (form.product_id.value || "").trim();
                const nm = (form.name.value || "").trim();
                const cat = (form.category_id.value || "all").trim();
                const sub = (form.sub_category_id.value || "all").trim();

                const featured = form.is_featured && form.is_featured.checked;
                const hotDeal = form.is_hot_deal && form.is_hot_deal.checked;

                // enforce dependency
                if (cat === "all") {
                    form.sub_category_id.value = "all";
                }

                const hasAny =
                    !!pid ||
                    !!nm ||
                    (cat !== "all") ||
                    (cat !== "all" && sub !== "all") ||
                    featured ||
                    hotDeal;

                if (!hasAny) {
                    e.preventDefault();
                    alert("Please enter at least one search field.");
                    return;
                }

                // Write trimmed values back
                form.product_id.value = pid;
                form.name.value = nm;
            });
        }
}) ();
    </script>
</body>

</html>