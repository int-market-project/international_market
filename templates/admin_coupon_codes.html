<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{page_title}}</title>
    <link rel="stylesheet" href="/css/admin-main.css">
    <link rel="stylesheet" href="/css/admin-login.css">
    <link rel="stylesheet" href="/css/admin-coupon.css">
</head>

<body>
    <header class="admin-section admin-header">
        <div class="admin-header-home-button">
            <a href="/core/ops/admin/dashboard" class="quicksand-text white-text text">Home</a>
        </div>
        <div class="admin-header-home-button">
            <a target="_blank" href="/" class="quicksand-text white-text text">Go to Store</a>
        </div>
        <div class="admin-header-logout-button">
            <a href="/core/ops/admin/logout" class="quicksand-text white-text text">Signout</a>
        </div>
    </header>
    <section class="admin-section admin-page-title">
        <h1 class="rhino-text quicksand-text title">Admin Panel</h1>
    </section>
    <script>
        (async function adminGuard() {
            try {
                // Call auth check endpoint (cookie is sent automatically by browser)
                const res = await fetch("/core/ops/admin/api/auth/check", {
                    method: "GET",
                    credentials: "same-origin",
                    cache: "no-store",
                });

                if (!res.ok) {
                    // Not logged in → send to admin login
                    window.location.replace("/core/ops/admin/login");
                    return;
                }
            } catch (err) {
                // If server unreachable or anything weird → safer to go login
                window.location.replace("/core/ops/admin/login");
            }
        })();
    </script>
    <section class="admin-section">
        <div class="cc-page-wrap">

            <div class="cc-page-top">
                <div class="cc-title-block">
                    <h2 class="rhino-text quicksand-text sub-title">{{ heading }}</h2>
                    <p class="lato-text text gray-text">
                        View existing coupon codes and delete them if needed. Create new coupon codes from the button.
                    </p>
                </div>

                <div class="cc-actions">
                    <a href="/core/ops/admin/dashboard/add-coupon-code" class="cc-create-btn quicksand-text text">
                        + Create New
                    </a>
                </div>
            </div>

            <div class="cc-list" id="couponCodesList">

                {% if coupons and coupons|length > 0 %}
                {% for c in coupons %}
                <div class="cc-item" data-code="{{ c.code }}">
                    <div class="cc-left">
                        <a class="cc-code-link quicksand-text text"
                            href="/core/ops/admin/dashboard/edit-coupon-code/{{ c.code }}">
                            {{ c.code }}
                        </a>

                        <div class="cc-meta">
                            <span class="lato-text text gray-text">
                                {{ c.title }}
                            </span>
                            <span class="cc-dot"></span>
                            <span class="lato-text text gray-text">
                                {{ c.discount_value }}{% if c.discount_type == "percent" %}%{% else %}${% endif %}
                            </span>
                            <span class="cc-dot"></span>
                            <span class="lato-text text gray-text">
                                Audience: {{ c.audience }}
                            </span>
                            <span class="cc-dot"></span>
                            <span class="lato-text text gray-text">
                                Uses: {{ c.uses_total }}{% if c.max_uses_total and c.max_uses_total > 0 %} / {{
                                c.max_uses_total }}{% else %} / ∞{% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="cc-right">
                        <button type="button" class="cc-delete-btn quicksand-text text" data-delete="{{ c.code }}">
                            Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="cc-empty">
                    <h3 class="rhino-text quicksand-text sub-sub-title">No coupon codes yet</h3>
                    <p class="lato-text text gray-text">
                        Create your first coupon code to start offering discounts.
                    </p>
                    <a href="/core/ops/admin/dashboard/add-coupon-code" class="cc-create-btn quicksand-text text">
                        + Create New
                    </a>
                </div>
                {% endif %}

            </div>

            <!-- small toast / inline feedback -->
            <div class="cc-toast lato-text text" id="ccToast" aria-live="polite"></div>

        </div>
    </section>
    <script>
        (function () {
            const list = document.getElementById("couponCodesList");
            const toast = document.getElementById("ccToast");

            function showToast(msg, isError = false) {
                if (!toast) return;
                toast.textContent = msg;
                toast.classList.remove("show", "error");
                if (isError) toast.classList.add("error");
                // force reflow for animation
                void toast.offsetWidth;
                toast.classList.add("show");

                setTimeout(() => {
                    toast.classList.remove("show");
                }, 2200);
            }

            async function deleteCoupon(code) {
                const res = await fetch(`/core/ops/admin/api/coupon-codes/delete/${encodeURIComponent(code)}`, {
                    method: "DELETE",
                    credentials: "same-origin",
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!res.ok) {
                    let detail = "Failed to delete coupon code.";
                    try {
                        const data = await res.json();
                        if (data && data.detail) detail = data.detail;
                    } catch (_) { }
                    throw new Error(detail);
                }

                return await res.json();
            }

            function removeItemFromDOM(code) {
                const el = document.querySelector(`.cc-item[data-code="${CSS.escape(code)}"]`);
                if (el) el.remove();

                // if list becomes empty, show a simple empty state without full reload
                const remaining = document.querySelectorAll(".cc-item");
                if (!remaining || remaining.length === 0) {
                    list.innerHTML = `
        <div class="cc-empty">
          <h3 class="rhino-text quicksand-text sub-sub-title">No coupon codes yet</h3>
          <p class="lato-text text gray-text">
            Create your first coupon code to start offering discounts.
          </p>
          <a href="/core/ops/admin/dashboard/add-coupon-code"
            class="cc-create-btn quicksand-text text">
            + Create New
          </a>
        </div>
      `;
                }
            }

            if (!list) return;

            list.addEventListener("click", async (e) => {
                const btn = e.target.closest("[data-delete]");
                if (!btn) return;

                const code = btn.getAttribute("data-delete");
                if (!code) return;

                const ok = confirm(`Delete coupon code "${code}"?\nThis cannot be undone.`);
                if (!ok) return;

                // disable button while deleting
                btn.disabled = true;
                btn.classList.add("loading");

                try {
                    await deleteCoupon(code);
                    removeItemFromDOM(code);
                    showToast(`Deleted ${code}`);
                } catch (err) {
                    showToast(err.message || "Failed to delete.", true);
                    btn.disabled = false;
                    btn.classList.remove("loading");
                }
            });
        })();
    </script>
</body>

</html>