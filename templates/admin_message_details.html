<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{page_title}}</title>
    <link rel="stylesheet" href="/css/admin-main.css">
    <link rel="stylesheet" href="/css/admin-login.css">
    <link rel="stylesheet" href="/css/admin-messages.css">
</head>

<body>
    <header class="admin-section admin-header">
        <div class="admin-header-home-button">
            <a href="/core/ops/admin/dashboard" class="quicksand-text white-text text">Home</a>
        </div>
        <div class="admin-header-home-button">
            <a target="_blank" href="/" class="quicksand-text white-text text">Go to Store</a>
        </div>
        <div class="admin-header-logout-button">
            <a href="/core/ops/admin/logout" class="quicksand-text white-text text">Signout</a>
        </div>
    </header>
    <section class="admin-section admin-page-title">
        <h1 class="rhino-text quicksand-text title">Admin Panel</h1>
    </section>
    <script>
        (async function adminGuard() {
            try {
                // Call auth check endpoint (cookie is sent automatically by browser)
                const res = await fetch("/core/ops/admin/api/auth/check", {
                    method: "GET",
                    credentials: "same-origin",
                    cache: "no-store",
                });

                if (!res.ok) {
                    // Not logged in → send to admin login
                    window.location.replace("/core/ops/admin/login");
                    return;
                }
            } catch (err) {
                // If server unreachable or anything weird → safer to go login
                window.location.replace("/core/ops/admin/login");
            }
        })();
    </script>
    <section class="admin-section">
        <div class="msg-details-wrap">

            <div class="msg-page-top">
                <div>
                    <h2 class="rhino-text quicksand-text sub-title">{{ heading }}</h2>
                    <p class="lato-text text gray-text">
                        Review the user message and send a reply. After sending, this message will be marked as replied.
                    </p>
                </div>

                <div class="msg-actions">
                    <a href="/core/ops/admin/dashboard/all-messages/" class="msg-action-btn quicksand-text text">←
                        Back</a>
                </div>
            </div>

            {% if error %}
            <div class="msg-error lato-text text">{{ error }}</div>
            {% endif %}

            <div class="msg-card">

                <!-- Message Summary -->
                <div class="msg-kv-grid">
                    <div class="msg-kv">
                        <div class="lato-text text gray-text">Message ID</div>
                        <div class="lato-text text msg-strong">{{ msg.message_id }}</div>
                    </div>

                    <div class="msg-kv">
                        <div class="lato-text text gray-text">Source</div>
                        <div class="lato-text text">{{ msg.source }}</div>
                    </div>

                    <div class="msg-kv">
                        <div class="lato-text text gray-text">Sent At</div>
                        <div class="lato-text text">
                            {% if msg.sent_at %}
                            {{ msg.sent_at.strftime("%B %d, %Y · %I:%M %p") }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="msg-panel">
                    <h3 class="rhino-text quicksand-text sub-sub-title">User Information</h3>
                    <div class="msg-info lato-text text">
                        <div><strong>Name:</strong> {{ msg.full_name }}</div>
                        <div><strong>Email:</strong> {{ msg.email }}</div>
                        <div><strong>Phone:</strong> {{ msg.phone_number }}</div>
                    </div>
                </div>

                <!-- User Message -->
                <div class="msg-panel">
                    <h3 class="rhino-text quicksand-text sub-sub-title">User Message</h3>
                    <div class="msg-user-message lato-text text">
                        {{ msg.message }}
                    </div>
                </div>

                <!-- Reply Form -->
                <div class="msg-panel msg-reply-panel">
                    <h3 class="rhino-text quicksand-text sub-sub-title">Admin Reply</h3>
                    <p class="lato-text text gray-text">
                        The reply will be emailed to the user and saved in the database.
                    </p>

                    <form method="post" action="/core/ops/admin/api/messages/reply/{{ msg.message_id }}"
                        class="msg-form" id="msg-reply-form">

                        <div>
                            <label class="lato-text text gray-text">Reply Subject *</label>
                            <input class="msg-input" type="text" name="admin_reply_subject" id="admin_reply_subject"
                                value="{{ defaults.admin_reply_subject }}"
                                placeholder="e.g. Re: Your message to International Market" required>
                        </div>

                        <div>
                            <label class="lato-text text gray-text">Reply Message *</label>
                            <textarea class="msg-textarea" name="admin_reply_message" id="admin_reply_message" rows="7"
                                placeholder="Type your reply here..."
                                required>{{ defaults.admin_reply_message }}</textarea>
                        </div>

                        <button type="submit" class="msg-primary-btn quicksand-text text" id="btn-send-reply">
                            Send Reply
                        </button>

                    </form>
                </div>

            </div>

        </div>
    </section>
    <script>
        (function () {
            const form = document.getElementById("msg-reply-form");
            const subj = document.getElementById("admin_reply_subject");
            const body = document.getElementById("admin_reply_message");
            const btn = document.getElementById("btn-send-reply");

            if (!form) return;

            form.addEventListener("submit", (e) => {
                const s = (subj?.value || "").trim();
                const m = (body?.value || "").trim();

                if (s.length < 2) {
                    e.preventDefault();
                    alert("Reply subject must be at least 2 characters.");
                    return;
                }
                if (s.length > 150) {
                    e.preventDefault();
                    alert("Reply subject is too long (max 150 characters).");
                    return;
                }
                if (m.length < 2) {
                    e.preventDefault();
                    alert("Reply message must be at least 2 characters.");
                    return;
                }
                if (m.length > 8000) {
                    e.preventDefault();
                    alert("Reply message is too long (max 8000 characters).");
                    return;
                }

                if (!confirm("Send this reply to the user and mark this message as replied?")) {
                    e.preventDefault();
                    return;
                }

                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = "0.7";
                    btn.style.pointerEvents = "none";
                }
                // normal submit -> backend -> redirect -> page reload
            });
        })();
    </script>
</body>

</html>